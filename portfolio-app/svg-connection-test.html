<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Connection Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .test-container {
            position: relative;
            width: 800px;
            height: 600px;
            border: 2px solid #333;
            background: white;
            margin: 20px auto;
        }
        
        .tasks-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }
        
        .connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2;
            border: 1px dashed rgba(255, 0, 0, 0.3); /* Debug border */
        }
        
        .task-node {
            position: absolute;
            width: 150px;
            height: 60px;
            background: white;
            border: 2px solid #017cee;
            border-radius: 8px;
            padding: 10px;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            margin: 0 10px;
            padding: 10px 15px;
            background: #017cee;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #005bb5;
        }
        
        .debug-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 800px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>SVG Connection Debugging</h1>
    
    <div class="controls">
        <button onclick="drawBasicLine()">Draw Basic Line</button>
        <button onclick="drawTaskConnections()">Draw Task Connections</button>
        <button onclick="testTransforms()">Test With Transforms</button>
        <button onclick="inspectElements()">Inspect Elements</button>
        <button onclick="clearAll()">Clear All</button>
    </div>
    
    <div class="debug-info" id="debug-info">
        <strong>Debug Log:</strong><br>
        <div id="log-content">Ready for testing...</div>
    </div>
    
    <div class="test-container">
        <div class="tasks-layer" id="tasks-layer">
            <svg class="connections-layer" width="800" height="600" id="svg-layer">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                     refX="10" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                    </marker>
                </defs>
                <g id="connections-group">
                    <!-- Connections will be drawn here -->
                </g>
            </svg>
            
            <div class="task-node" id="task1" style="transform: translate(100px, 100px);">Task A</div>
            <div class="task-node" id="task2" style="transform: translate(400px, 200px);">Task B</div>
            <div class="task-node" id="task3" style="transform: translate(600px, 100px);">Task C</div>
        </div>
    </div>

    <script>
        const logContent = document.getElementById('log-content');
        const connectionsGroup = document.getElementById('connections-group');
        const tasksLayer = document.getElementById('tasks-layer');
        const svgLayer = document.getElementById('svg-layer');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<br>[${timestamp}] ${message}`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }
        
        function clearAll() {
            connectionsGroup.innerHTML = '';
            tasksLayer.style.transform = '';
            logContent.innerHTML = 'Cleared all connections and transforms';
        }
        
        function drawBasicLine() {
            clearAll();
            log('Drawing basic red line from (50,50) to (750,550)');
            
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M 50 50 L 750 550');
            path.setAttribute('stroke', '#ff0000');
            path.setAttribute('stroke-width', '5');
            path.setAttribute('fill', 'none');
            path.setAttribute('id', 'basic-line');
            
            connectionsGroup.appendChild(path);
            
            // Verify it was added
            const addedPath = connectionsGroup.querySelector('#basic-line');
            log(`✅ Basic line added successfully: ${!!addedPath}`);
            log(`Line d attribute: ${addedPath ? addedPath.getAttribute('d') : 'N/A'}`);
        }
        
        function drawTaskConnections() {
            clearAll();
            log('Drawing connections between tasks using their positions');
            
            // Task positions (from transform: translate values)
            const tasks = [
                { id: 'task1', x: 100, y: 100, width: 150, height: 60 },
                { id: 'task2', x: 400, y: 200, width: 150, height: 60 },
                { id: 'task3', x: 600, y: 100, width: 150, height: 60 }
            ];
            
            // Draw A -> B and B -> C
            const connections = [
                { from: 0, to: 1, color: '#017cee' },
                { from: 1, to: 2, color: '#10b981' }
            ];
            
            connections.forEach((conn, index) => {
                const fromTask = tasks[conn.from];
                const toTask = tasks[conn.to];
                
                // Calculate connection points
                const fromX = fromTask.x + fromTask.width;
                const fromY = fromTask.y + fromTask.height / 2;
                const toX = toTask.x;
                const toY = toTask.y + toTask.height / 2;
                
                log(`Connection ${index + 1}: ${fromTask.id} -> ${toTask.id}`);
                log(`  From: (${fromX}, ${fromY}) To: (${toX}, ${toY})`);
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const d = `M ${fromX} ${fromY} C ${fromX + 50} ${fromY} ${toX - 50} ${toY} ${toX} ${toY}`;
                path.setAttribute('d', d);
                path.setAttribute('stroke', conn.color);
                path.setAttribute('stroke-width', '3');
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrowhead)');
                path.setAttribute('id', `connection-${index}`);
                
                connectionsGroup.appendChild(path);
                log(`  Path d: ${d}`);
            });
            
            const pathCount = connectionsGroup.querySelectorAll('path').length;
            log(`✅ Drew ${pathCount} task connections`);
        }
        
        function testTransforms() {
            log('Testing with CSS transforms applied to tasks layer');
            
            // First draw the connections
            drawTaskConnections();
            
            // Then apply a transform to the tasks layer
            const transform = 'translate(50px, 30px) scale(1.2)';
            tasksLayer.style.transform = transform;
            
            log(`Applied transform to tasks layer: ${transform}`);
            log('Note: SVG should transform with the HTML elements now');
        }
        
        function inspectElements() {
            log('=== Element Inspection ===');
            log(`SVG element exists: ${!!svgLayer}`);
            log(`SVG dimensions: ${svgLayer.getAttribute('width')} x ${svgLayer.getAttribute('height')}`);
            log(`SVG computed size: ${svgLayer.clientWidth} x ${svgLayer.clientHeight}`);
            log(`Connections group exists: ${!!connectionsGroup}`);
            log(`Paths in connections group: ${connectionsGroup.querySelectorAll('path').length}`);
            
            const svgRect = svgLayer.getBoundingClientRect();
            log(`SVG bounding rect: (${svgRect.left}, ${svgRect.top}) ${svgRect.width}x${svgRect.height}`);
            
            const tasksRect = tasksLayer.getBoundingClientRect();
            log(`Tasks layer bounding rect: (${tasksRect.left}, ${tasksRect.top}) ${tasksRect.width}x${tasksRect.height}`);
            log(`Tasks layer transform: ${tasksLayer.style.transform || 'none'}`);
            
            // Check each task node
            ['task1', 'task2', 'task3'].forEach(taskId => {
                const task = document.getElementById(taskId);
                const rect = task.getBoundingClientRect();
                log(`${taskId}: transform="${task.style.transform}", rect=(${rect.left}, ${rect.top})`);
            });
        }
        
        // Initial inspection
        setTimeout(() => {
            log('=== Initial Setup Complete ===');
            inspectElements();
            log('Ready for testing. Click buttons above to test different scenarios.');
        }, 100);
    </script>
</body>
</html>
