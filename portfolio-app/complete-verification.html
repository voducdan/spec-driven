<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úÖ Enhanced Connections - Verification Complete</title>
    <link rel="stylesheet" href="src/styles/airflow-theme.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .header {
            text-align: center;
            padding: 30px 20px;
            background: rgba(0,0,0,0.2);
        }
        .verification-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .verification-card {
            background: rgba(255,255,255,0.95);
            color: #1f2937;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }
        .card-content {
            line-height: 1.6;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-pass { background: #10b981; }
        .status-fail { background: #ef4444; }
        .status-pending { background: #f59e0b; }
        .test-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        .test-button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .workflow-container {
            background: rgba(255,255,255,0.95);
            margin: 20px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .workflow-header {
            background: #1f2937;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .console-output {
            background: #1e293b;
            color: #e2e8f0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
            margin: 20px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .summary-banner {
            background: linear-gradient(45deg, #10b981, #059669);
            color: white;
            padding: 20px;
            text-align: center;
            margin: 20px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.3);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üéâ Enhanced SVG Connections - Complete Verification</h1>
        <p>Testing all three fixes + missing method resolution</p>
        <div>
            <button class="test-button" onclick="runCompleteTest()">üß™ Run Complete Test</button>
            <button class="test-button" onclick="testZoomPan()">üîç Test Zoom/Pan</button>
            <button class="test-button" onclick="testAllButtons()">üéõÔ∏è Test All Controls</button>
        </div>
    </div>

    <div class="verification-grid">
        <div class="verification-card">
            <div class="card-header">
                <span>üé®</span>
                <span>Connection Quality</span>
                <span class="status-indicator status-pending" id="quality-indicator"></span>
            </div>
            <div class="card-content">
                <div id="quality-details">Testing smart routing algorithm...</div>
                <div style="margin-top: 10px; font-size: 12px; opacity: 0.7;">
                    Direct, curved, and stepped connection paths
                </div>
            </div>
        </div>

        <div class="verification-card">
            <div class="card-header">
                <span>üîó</span>
                <span>Group Connections</span>
                <span class="status-indicator status-pending" id="groups-indicator"></span>
            </div>
            <div class="card-content">
                <div id="groups-details">Testing group-to-group connections...</div>
                <div style="margin-top: 10px; font-size: 12px; opacity: 0.7;">
                    Inter-group connections with descriptive labels
                </div>
            </div>
        </div>

        <div class="verification-card">
            <div class="card-header">
                <span>üîÑ</span>
                <span>Transform Sync</span>
                <span class="status-indicator status-pending" id="transform-indicator"></span>
            </div>
            <div class="card-content">
                <div id="transform-details">Testing zoom/pan synchronization...</div>
                <div style="margin-top: 10px; font-size: 12px; opacity: 0.7;">
                    Connections follow all canvas transformations
                </div>
            </div>
        </div>

        <div class="verification-card">
            <div class="card-header">
                <span>üõ†Ô∏è</span>
                <span>Missing Methods</span>
                <span class="status-indicator status-pending" id="methods-indicator"></span>
            </div>
            <div class="card-content">
                <div id="methods-details">Testing centerDAG and toggleGroups...</div>
                <div style="margin-top: 10px; font-size: 12px; opacity: 0.7;">
                    centerDAG(), toggleGroups() methods resolved
                </div>
            </div>
        </div>
    </div>

    <div class="workflow-container">
        <div class="workflow-header">
            <span>üìä Portfolio Workflow Canvas - Enhanced & Verified</span>
            <span id="live-status">üü° Initializing...</span>
        </div>
        <div id="workflow-container" style="height: 500px; background: #f9fafb;"></div>
    </div>

    <div class="console-output" id="console-output">
        <div style="color: #10b981; font-weight: bold;">üîç Live Console Output:</div>
    </div>

    <div class="summary-banner" id="summary-banner" style="display: none;">
        üéâ ALL ENHANCED CONNECTION ISSUES RESOLVED! üéâ
    </div>

    <script>
        // Console capture
        const consoleOutput = document.getElementById('console-output');
        const originalLog = console.log;

        console.log = (...args) => {
            originalLog(...args);
            const div = document.createElement('div');
            div.style.marginBottom = '2px';
            div.textContent = args.join(' ');
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };

        // Status update functions
        function updateStatus(indicatorId, detailsId, status, message) {
            const indicator = document.getElementById(indicatorId);
            const details = document.getElementById(detailsId);
            
            indicator.className = `status-indicator status-${status}`;
            details.textContent = message;
        }

        // Test functions
        function testConnectionQuality() {
            console.log('üé® Testing connection quality...');
            
            const connections = document.querySelectorAll('.task-connection');
            const directConnections = document.querySelectorAll('.connection-direct');
            const curvedConnections = document.querySelectorAll('.connection-curved');
            const steppedConnections = document.querySelectorAll('.connection-stepped');
            
            const hasConnections = connections.length > 0;
            const hasVariety = directConnections.length > 0 || curvedConnections.length > 0 || steppedConnections.length > 0;
            
            if (hasConnections && hasVariety) {
                updateStatus('quality-indicator', 'quality-details', 'pass', 
                    `‚úÖ PASS: ${connections.length} connections with smart routing`);
                return true;
            } else if (hasConnections) {
                updateStatus('quality-indicator', 'quality-details', 'fail', 
                    `‚ö†Ô∏è PARTIAL: ${connections.length} basic connections only`);
                return false;
            } else {
                updateStatus('quality-indicator', 'quality-details', 'fail', 
                    '‚ùå FAIL: No connections found');
                return false;
            }
        }

        function testGroupConnections() {
            console.log('üîó Testing group connections...');
            
            const groupSources = document.querySelectorAll('.connection-group-source');
            const groupTargets = document.querySelectorAll('.connection-group-target');
            const labels = document.querySelectorAll('.connection-label');
            
            const hasGroupConnections = groupSources.length > 0 || groupTargets.length > 0;
            const hasLabels = labels.length > 0;
            
            if (hasGroupConnections && hasLabels) {
                updateStatus('groups-indicator', 'groups-details', 'pass', 
                    `‚úÖ PASS: ${Math.max(groupSources.length, groupTargets.length)} group connections with ${labels.length} labels`);
                return true;
            } else if (hasGroupConnections) {
                updateStatus('groups-indicator', 'groups-details', 'fail', 
                    '‚ö†Ô∏è PARTIAL: Group connections without labels');
                return false;
            } else {
                updateStatus('groups-indicator', 'groups-details', 'fail', 
                    '‚ùå FAIL: No group connections found');
                return false;
            }
        }

        function testTransformSync() {
            console.log('üîÑ Testing transform sync...');
            
            const connectionsLayer = document.querySelector('#connections-layer');
            const tasksLayer = document.querySelector('#tasks-layer');
            
            if (!connectionsLayer || !tasksLayer) {
                updateStatus('transform-indicator', 'transform-details', 'fail', 
                    '‚ùå FAIL: Missing SVG layers');
                return false;
            }
            
            const connectionsTransform = connectionsLayer.getAttribute('transform') || 'none';
            const tasksTransform = tasksLayer.getAttribute('transform') || 'none';
            
            if (connectionsTransform === tasksTransform && connectionsTransform !== 'none') {
                updateStatus('transform-indicator', 'transform-details', 'pass', 
                    '‚úÖ PASS: Layers synchronized');
                return true;
            } else {
                updateStatus('transform-indicator', 'transform-details', 'fail', 
                    '‚ùå FAIL: Layers not synchronized');
                return false;
            }
        }

        function testMissingMethods() {
            console.log('üõ†Ô∏è Testing missing methods...');
            
            const canvas = window.debugCanvas;
            if (!canvas) {
                updateStatus('methods-indicator', 'methods-details', 'fail', 
                    '‚ùå FAIL: Canvas instance not found');
                return false;
            }
            
            const hasCenterDAG = typeof canvas.centerDAG === 'function';
            const hasToggleGroups = typeof canvas.toggleGroups === 'function';
            
            if (hasCenterDAG && hasToggleGroups) {
                updateStatus('methods-indicator', 'methods-details', 'pass', 
                    '‚úÖ PASS: All methods available');
                return true;
            } else {
                updateStatus('methods-indicator', 'methods-details', 'fail', 
                    `‚ùå FAIL: Missing ${!hasCenterDAG ? 'centerDAG ' : ''}${!hasToggleGroups ? 'toggleGroups' : ''}`);
                return false;
            }
        }

        function runCompleteTest() {
            console.log('üß™ Running complete verification test...');
            document.getElementById('live-status').innerHTML = 'üîÑ Testing...';
            
            setTimeout(() => {
                const qualityPass = testConnectionQuality();
                const groupsPass = testGroupConnections();
                const transformPass = testTransformSync();
                const methodsPass = testMissingMethods();
                
                const allPass = qualityPass && groupsPass && transformPass && methodsPass;
                
                if (allPass) {
                    document.getElementById('live-status').innerHTML = 'üü¢ All Tests Passed!';
                    document.getElementById('summary-banner').style.display = 'block';
                    console.log('üéâ SUCCESS: All enhanced connection issues resolved!');
                } else {
                    document.getElementById('live-status').innerHTML = 'üî¥ Some Tests Failed';
                    console.log('‚ö†Ô∏è Some issues remain - check individual test results');
                }
            }, 2000);
        }

        function testZoomPan() {
            console.log('üîç Testing zoom/pan behavior...');
            if (window.debugCanvas) {
                window.debugCanvas.zoom(1.3);
                setTimeout(() => {
                    window.debugCanvas.zoom(0.7);
                    setTimeout(() => testTransformSync(), 500);
                }, 1000);
            }
        }

        function testAllButtons() {
            console.log('üéõÔ∏è Testing all control buttons...');
            const canvas = window.debugCanvas;
            if (canvas) {
                try {
                    canvas.centerDAG();
                    console.log('‚úÖ centerDAG() works');
                    setTimeout(() => {
                        canvas.toggleGroups();
                        console.log('‚úÖ toggleGroups() works');
                        setTimeout(() => {
                            canvas.autoLayoutTasks();
                            console.log('‚úÖ autoLayoutTasks() works');
                        }, 1000);
                    }, 1000);
                } catch (error) {
                    console.error('‚ùå Button test failed:', error.message);
                }
            }
        }

        // Global test functions
        window.runCompleteTest = runCompleteTest;
        window.testZoomPan = testZoomPan;
        window.testAllButtons = testAllButtons;
    </script>

    <script type="module">
        import { WorkflowCanvas } from './src/components/WorkflowCanvas.js';
        import { portfolioData } from './src/data/portfolio-data.js';

        console.log('üöÄ Initializing complete verification test...');
        
        try {
            const canvas = new WorkflowCanvas('workflow-container', portfolioData);
            window.debugCanvas = canvas;
            
            canvas.init();
            console.log('‚úÖ Canvas initialized successfully for verification');
            
            // Auto-run complete test after initialization
            setTimeout(() => {
                console.log('üîÑ Auto-running complete verification...');
                runCompleteTest();
            }, 3000);
            
        } catch (error) {
            console.error('‚ùå Failed to initialize canvas:', error);
            document.getElementById('live-status').innerHTML = 'üî¥ Initialization Failed';
        }
    </script>
</body>
</html>
