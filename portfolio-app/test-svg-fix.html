<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Connection Fix Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: #f5f5f5;
        }
        
        .test-container {
            position: relative;
            width: 800px;
            height: 600px;
            border: 2px solid #333;
            background: white;
            margin: 20px auto;
            overflow: hidden;
        }
        
        .tasks-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: 0 0;
        }
        
        .connections-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 15; /* High z-index like our fix */
            overflow: visible;
        }
        
        .task-node {
            position: absolute;
            width: 150px;
            height: 60px;
            background: white;
            border: 2px solid #017cee;
            border-radius: 8px;
            padding: 10px;
            z-index: 10; /* Lower than connections */
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .task-connection {
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.8;
            transition: all 0.3s ease;
        }
        
        .task-connection:hover {
            opacity: 1;
            stroke-width: 6 !important;
            filter: drop-shadow(0 0 6px currentColor);
        }
        
        .controls {
            text-align: center;
            margin: 20px 0;
        }
        
        button {
            margin: 0 10px;
            padding: 10px 15px;
            background: #017cee;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        button:hover {
            background: #005bb5;
        }
        
        .debug-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin: 20px auto;
            max-width: 800px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>SVG Connection Fix Verification</h1>
    <p>This test demonstrates the z-index and positioning fixes for SVG connections.</p>
    
    <div class="controls">
        <button onclick="drawConnections()">Draw Connections</button>
        <button onclick="testTransform()">Test with Transform</button>
        <button onclick="inspectLayers()">Inspect Layers</button>
        <button onclick="clearAll()">Clear All</button>
    </div>
    
    <div class="debug-info" id="debug-info">
        <strong>Debug Log:</strong><br>
        <div id="log-content">Ready for testing...</div>
    </div>
    
    <div class="test-container">
        <div class="tasks-layer" id="tasks-layer">
            <svg class="connections-layer" width="800" height="600" id="svg-layer">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
                     refX="10" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                    </marker>
                </defs>
                <g id="connections-group">
                    <!-- Connections will be drawn here -->
                </g>
            </svg>
            
            <div class="task-node" id="task1" style="transform: translate(100px, 100px);">Task A</div>
            <div class="task-node" id="task2" style="transform: translate(400px, 200px);">Task B</div>
            <div class="task-node" id="task3" style="transform: translate(600px, 100px);">Task C</div>
        </div>
    </div>

    <script>
        const logContent = document.getElementById('log-content');
        const connectionsGroup = document.getElementById('connections-group');
        const tasksLayer = document.getElementById('tasks-layer');
        const svgLayer = document.getElementById('svg-layer');
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<br>[${timestamp}] ${message}`;
            logContent.scrollTop = logContent.scrollHeight;
            console.log(message);
        }
        
        function clearAll() {
            connectionsGroup.innerHTML = '';
            tasksLayer.style.transform = '';
            logContent.innerHTML = 'Cleared all connections and transforms';
        }
        
        function drawConnections() {
            clearAll();
            log('Drawing connections with z-index fix applied');
            
            // Task positions (from transform: translate values)
            const tasks = [
                { id: 'task1', x: 100, y: 100, width: 150, height: 60 },
                { id: 'task2', x: 400, y: 200, width: 150, height: 60 },
                { id: 'task3', x: 600, y: 100, width: 150, height: 60 }
            ];
            
            // Draw A -> B and B -> C
            const connections = [
                { from: 0, to: 1, color: '#017cee' },
                { from: 1, to: 2, color: '#10b981' }
            ];
            
            connections.forEach((conn, index) => {
                const fromTask = tasks[conn.from];
                const toTask = tasks[conn.to];
                
                // Calculate connection points (improved calculation like our fix)
                const fromX = fromTask.x + fromTask.width;
                const fromY = fromTask.y + fromTask.height / 2;
                const toX = toTask.x;
                const toY = toTask.y + toTask.height / 2;
                
                log(`Connection ${index + 1}: ${fromTask.id} -> ${toTask.id}`);
                log(`  From: (${fromX}, ${fromY}) To: (${toX}, ${toY})`);
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                
                // Use the improved curve calculation from our fix
                const controlOffset = Math.abs(toX - fromX) * 0.4;
                const d = `M ${fromX} ${fromY} C ${fromX + controlOffset} ${fromY} ${toX - controlOffset} ${toY} ${toX} ${toY}`;
                
                path.setAttribute('d', d);
                path.setAttribute('stroke', conn.color);
                path.setAttribute('stroke-width', '4'); // Thicker like our fix
                path.setAttribute('fill', 'none');
                path.setAttribute('marker-end', 'url(#arrowhead)');
                path.setAttribute('class', 'task-connection');
                path.setAttribute('id', `connection-${index}`);
                
                connectionsGroup.appendChild(path);
                log(`  Path d: ${d}`);
                
                // Log bounding rect like our enhanced debug
                const pathRect = path.getBoundingClientRect();
                log(`  Bounding rect: ${JSON.stringify(pathRect)}`);
            });
            
            const pathCount = connectionsGroup.querySelectorAll('path').length;
            log(`âœ… Drew ${pathCount} connections with z-index: ${getComputedStyle(svgLayer).zIndex}`);
        }
        
        function testTransform() {
            log('Testing connections with CSS transforms (like pan/zoom)');
            
            // First draw the connections
            drawConnections();
            
            // Then apply a transform to the tasks layer
            const transform = 'translate(50px, 30px) scale(1.2)';
            tasksLayer.style.transform = transform;
            log(`Applied transform: ${transform}`);
            log('âœ… Connections should move with HTML elements due to unified container');
        }
        
        function inspectLayers() {
            log('=== Layer Z-Index Inspection ===');
            log(`SVG layer z-index: ${getComputedStyle(svgLayer).zIndex}`);
            log(`Task nodes z-index: ${getComputedStyle(document.getElementById('task1')).zIndex}`);
            log(`SVG position: ${getComputedStyle(svgLayer).position}`);
            log(`Tasks layer position: ${getComputedStyle(tasksLayer).position}`);
            
            const svgRect = svgLayer.getBoundingClientRect();
            const tasksRect = tasksLayer.getBoundingClientRect();
            log(`SVG bounding rect: ${JSON.stringify(svgRect)}`);
            log(`Tasks layer bounding rect: ${JSON.stringify(tasksRect)}`);
            
            const paths = connectionsGroup.querySelectorAll('path');
            log(`Total paths in SVG: ${paths.length}`);
            paths.forEach((path, i) => {
                const rect = path.getBoundingClientRect();
                log(`Path ${i + 1} rect: ${JSON.stringify(rect)}`);
            });
        }
        
        // Auto-draw connections on load to show the fix working
        setTimeout(() => {
            drawConnections();
            log('ðŸŽ‰ Z-index fix demonstration loaded!');
            log('The connections should now be visible above the task nodes.');
        }, 500);
    </script>
</body>
</html>
